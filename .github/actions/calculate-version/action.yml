name: 'Calculate Version'
description: 'Calculate version and deployment parameters'
inputs:
  deployment-mode:
    description: 'Deployment mode (stage-only, production)'
    required: true
  version-bump:
    description: 'Version bump type (major, minor, patch)'
    required: false
    default: 'minor'
  deploy-docker:
    description: 'Deploy to Docker Hub'
    required: false
    default: 'true'
  deploy-snap:
    description: 'Deploy to Snap Store'
    required: false
    default: 'true'
  deploy-microsoft:
    description: 'Deploy to Microsoft Store'
    required: false
    default: 'true'
  deploy-apple:
    description: 'Deploy to Apple App Store'
    required: false
    default: 'true'
outputs:
  version:
    description: 'Calculated version'
    value: ${{ steps.version.outputs.version }}
  previous-version:
    description: 'Previous version'
    value: ${{ steps.version.outputs.previous-version }}
  deployment-mode:
    description: 'Deployment mode'
    value: ${{ steps.mode.outputs.mode }}
  stage-only:
    description: 'Stage only flag'
    value: ${{ steps.flags.outputs.stage-only }}
  deploy-docker:
    description: 'Deploy Docker flag'
    value: ${{ steps.stores.outputs.deploy-docker }}
  deploy-snap:
    description: 'Deploy Snap flag'
    value: ${{ steps.stores.outputs.deploy-snap }}
  deploy-microsoft:
    description: 'Deploy Microsoft flag'
    value: ${{ steps.stores.outputs.deploy-microsoft }}
  deploy-apple:
    description: 'Deploy Apple flag'
    value: ${{ steps.stores.outputs.deploy-apple }}

runs:
  using: 'composite'
  steps:
    - name: Set deployment mode
      id: mode
      shell: bash
      run: |
        MODE="${{ inputs.deployment-mode }}"
        echo "mode=$MODE" >> $GITHUB_OUTPUT
        echo "ðŸŽ¯ Deployment mode: $MODE"

    - name: Set flags
      id: flags
      shell: bash
      run: |
        MODE="${{ steps.mode.outputs.mode }}"

        if [ "$MODE" = "stage-only" ]; then
          STAGE_ONLY="true"
        else  # production
          STAGE_ONLY="false"
        fi

        echo "stage-only=$STAGE_ONLY" >> $GITHUB_OUTPUT
        echo "Stage only: $STAGE_ONLY"

    - name: Calculate version
      id: version
      shell: bash
      run: |
        # Get latest tag
        LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
        PREVIOUS_VERSION=${LATEST_TAG#v}

        # Calculate next version based on bump type
        IFS='.' read -r major minor patch <<< "$PREVIOUS_VERSION"
        BUMP_TYPE="${{ inputs.version-bump }}"

        case "$BUMP_TYPE" in
          "major")
            major=$((major + 1))
            minor=0
            patch=0
            ;;
          "minor")
            minor=$((minor + 1))
            patch=0
            ;;
          "patch")
            patch=$((patch + 1))
            ;;
          *)
            echo "Invalid version bump type: $BUMP_TYPE"
            exit 1
            ;;
        esac

        NEXT_VERSION="${major}.${minor}.${patch}"

        echo "version=$NEXT_VERSION" >> $GITHUB_OUTPUT
        echo "previous-version=$PREVIOUS_VERSION" >> $GITHUB_OUTPUT
        echo "ðŸ“¦ Version: $NEXT_VERSION (previous: $PREVIOUS_VERSION, bump: $BUMP_TYPE)"

    - name: Set store selection
      id: stores
      shell: bash
      run: |
        MODE="${{ steps.mode.outputs.mode }}"

        if [ "$MODE" = "production" ]; then
          # Production: deploy to all stores
          echo "deploy-docker=true" >> $GITHUB_OUTPUT
          echo "deploy-snap=true" >> $GITHUB_OUTPUT
          echo "deploy-microsoft=true" >> $GITHUB_OUTPUT
          echo "deploy-apple=true" >> $GITHUB_OUTPUT
          echo "Production mode: deploying to all stores"
        else
          # Stage-only: always deploy snap to edge, respect others
          echo "deploy-docker=${{ inputs.deploy-docker }}" >> $GITHUB_OUTPUT
          echo "deploy-snap=true" >> $GITHUB_OUTPUT  # Always deploy snap to edge
          echo "deploy-microsoft=${{ inputs.deploy-microsoft }}" >> $GITHUB_OUTPUT
          echo "deploy-apple=${{ inputs.deploy-apple }}" >> $GITHUB_OUTPUT
          echo "Stage-only mode: snap always deploys to edge"
        fi